<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Business Object</title>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.css">
<link rel="stylesheet" href="css/xeditable.css">
<link rel='stylesheet' href='//cdnjs.cloudflare.com/ajax/libs/angular-loading-bar/0.9.0/loading-bar.min.css' type='text/css' media='all' />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-switch/3.3.2/css/bootstrap3/bootstrap-switch.min.css">

<link rel="stylesheet" href="css/default.css">
<link rel="stylesheet" media="min-device-width: 800px" href="css/default.css" />
<!-- TODO: add stylesheets for different device sizes with coressponding media queries-->

</head>

<body ng-app="businessObjects">

	<div class="container-fluid">
		
		<div class="row-fluid page">
		
			<header class="page-title"><h1 class="h2">Business Objects Explorer</h1></header>
			
			<div class="page-content">
				<div ui-view="master" ng-show="masterVm.items.length" class="master col-xs-12 col-md-2 no-gutter-left"></div>
				<div ui-view="detail"></div>
			</div>
			<div ui-view="notifications" class="notification-bar"></div>
			
		</div>
		
	</div>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>	
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.js"></script>
	
	<script src="//cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.3.1/angular-ui-router.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/1.3.3/ui-bootstrap.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/1.3.3/ui-bootstrap-tpls.min.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular-resource.min.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular-animate.min.js"></script>
			
	<script src="js/xeditable.js"></script>	
	<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-switch/3.3.2/js/bootstrap-switch.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.15.0/jquery.validate.min.js"></script>
	<script src="js/ng-infinite-scroll.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/angular-loading-bar/0.9.0/loading-bar.min.js"></script>
	
	<script>
	angular.module('businessObjects', ['ngAnimate', 'ngResource', 'ui.router', 'ui.bootstrap', 'xeditable', 'infinite-scroll', 'angular-loading-bar'])
	.value('THROTTLE_MILLISECONDS', 500)
	.config(['$stateProvider', '$urlRouterProvider', 'cfpLoadingBarProvider', function($stateProvider, $urlRouterProvider, cfpLoadingBarProvider) {

		$urlRouterProvider.otherwise("/");
		
		$stateProvider
		.state('list', {
			  url: "/",
		      params: {
		    	  message: undefined,
		    	  selectedEntity: undefined
		      },
		      views: {
		          'master': {
		              templateUrl: 'views/master-list.html',
		              controller: 'MasterListCtrl',
		              controllerAs: 'masterVm'
		          },
		          'detail': {
		              templateUrl: 'views/empty.html',
		              controller: 'EmptyCtrl',
		              controllerAs: 'emptyVm'
		          },
		          'notifications': {
		              templateUrl: 'views/notifications.html',
		              controller: 'NotificationsCtrl',
		              controllerAs: 'messagesVm'
		          }
		      }
		    })
		.state('list.entity', {
			url: ":boId",
		    params: {
			  	selectedEntity: undefined
		    }, 
			resolve: { 
	            selectedEntity: ['$stateParams',
	                function($stateParams) {
	                	return $stateParams.selectedEntity;
                }]
            },
            views: {
		    	  'detail@': {
					  templateUrl: "views/detail_view.html",
					  controller: 'DetailsCtrl',
		              controllerAs: 'detailsVm'
			      }
		     }
		   })
		.state('list.entity.edit', {
			  url: "edit",
		      params: {
		    	  items: undefined,
		    	  selectedEntity: undefined,
		    	  entityForEdit: undefined,
		    	  message: {value: undefined}  
		      },
		      views: {
		          'master@': {
		              templateUrl: 'views/none.html'
		          },
			      'detail@': {
					  templateUrl: "views/detail_editor.html",
					  controller: 'EditCtrl',
		              controllerAs: 'detailsEditorVm'
			      }
		      }
		    })
		.state("list.entity.edit.items", {
			url: "property",
		    params: {
				selectedEntity: undefined,
				item: undefined,
				message: {value: undefined}
		    },
		    onEnter: ['$stateParams', '$state', '$uibModal', function($stateParams, $state, $modal) {
		    	
		    	function goBack(_selectedEntity) {
		        	$state.go("list.entity.edit", {selectedEntity: _selectedEntity}, {location:false});
		        }
		    	
		        var modalInstance = $modal.open({
		        	animation: true,
		            templateUrl: "views/propertyEditor.html",
		            resolve: {
		            	selectedEntity: function() { 
		            		return $stateParams.selectedEntity; 
		            	}
		            },
		            controller: 'PropertyEditorCtrl',
		            controllerAs: 'propsEditorVm'
		        });
		        modalInstance.rendered.then(function(){
		        	var $validator = $('.modal-body form').validate({
		        		errorClass: 'has-error',
		        		validClass : 'has-success',
 		        		highlight: function (element, errorClass, validClass) {
				            $(element).closest('.form-group').removeClass('has-success').addClass('has-error');
				            if($validator.numberOfInvalids()>0)
				            	$('.modal-footer .btn.btn-success').addClass('disabled');
				        },
				        unhighlight: function(element, errorClass, validClass) {
				        	$(element).closest('.form-group').removeClass('has-error').addClass('has-success');
				        	if($validator.numberOfInvalids()<1)
					        	$('.modal-footer .btn.btn-success').removeClass('disabled');	
				        },
		 		        success: "has-success"
		        	});
		        	$('.form-control[required]').each(function(i){
		        		$validator.element(this);
		        	});
		        });
		        modalInstance.result.then(goBack, goBack);
		    }]
		  });
		  
		cfpLoadingBarProvider.includeSpinner = false;
		  
	}])
	.service('modalService', ['$uibModal', function ($uibModal) {
		/* http://weblogs.asp.net/dwahlin/building-an-angularjs-modal-service */
		
		//TODO: add 'Don't show this dialog again' option 
		
        var modalDefaults = {
            backdrop: true,
            keyboard: true,
            modalFade: true,
            templateUrl: 'views/modal.html'
        };

        var modalOptions = {
            closeButtonText: 'Close',
            actionButtonText: 'OK',
            headerText: 'Proceed?',
            bodyText: 'Perform this action?'
        };

        this.showModal = function (customModalDefaults, customModalOptions) {
            if (!customModalDefaults) 
            	customModalDefaults = {};
            customModalDefaults.backdrop = 'static';
            return this.show(customModalDefaults, customModalOptions);
        };

        this.show = function (customModalDefaults, customModalOptions) {
            //Create temp objects to work with since we're in a singleton service
            var tempModalDefaults = {};
            var tempModalOptions = {};

            //Map angular-ui modal custom defaults to modal defaults defined in service
            angular.extend(tempModalDefaults, modalDefaults, customModalDefaults);

            //Map modal.html $scope custom properties to defaults defined in service
            angular.extend(tempModalOptions, modalOptions, customModalOptions);

            if (!tempModalDefaults.controller) {
                tempModalDefaults.controller = function ($scope, $uibModalInstance) {
                    $scope.modalOptions = tempModalOptions;
                    $scope.modalOptions.ok = function (result) {
                        $uibModalInstance.close(result);
                    };
                    $scope.modalOptions.close = function () {
                        $uibModalInstance.dismiss('cancel');
                    };
                }
            }

            return $uibModal.open(tempModalDefaults).result;
        };

    }])
	.service('ResourceSvcConfiguration', function() {
	
		return {
			cfg: {
			    save: {
			        method: 'POST',
			        interceptor: {
		                response: function(res) {
		                	var location = res.headers('Location');
		                	if(location){
		                		var id = location.substring(location.lastIndexOf('/')+1);
		                		angular.extend(res.resource, { "boh_id": id });
	                		} else {
	                			console.error('Cannot infer id after save operation. HTTP Response Header "Location" is missing: ' + location);
	            			}
	                        return res.resource;
		                }
		            }, 
		            isArray: false
			    },
			    update: {
			        method: 'PUT'
			    }
		    }
		};
	})
	.service('Entity', ['$resource', 'ResourceSvcConfiguration', function($resource, ResourceSvcConfiguration) {
		var cfg = angular.copy(ResourceSvcConfiguration.cfg);
		cfg.count = {method:'GET', params:{count:true}, isArray:false};
	  	var res = $resource('../../js/bo_modeller/bo_header.js/:boId', { boId:'@id' }, cfg);
		
		res.newObjectTemplate = {
				"boh_name":"Business Object Name",
				"boh_table":"Tbl",
				"boh_description":"Description for business object",
			};
			
		return res;
	}])
	.service('Item', ['$resource', 'ResourceSvcConfiguration', function($resource, ResourceSvcConfiguration) {
	
	  	var res = $resource('../../js/bo_modeller/bo_item.js/:boId', { boId:'@id' }, ResourceSvcConfiguration.cfg);
		
		
		res.newObjectTemplate = {
					"boi_name":"Item",
					"boi_column":"Item",
					"boi_type": "String"			
				};
		return res;
	}])	
	.service('BuildService', ['$resource', function($resource) {
	  	return $resource('../../js/bo_modeller/bo_build_svc.js', {}, {
	  		build: {
	  			method: 'POST',
	  			isArray: false
  			}
	  	});
	}])	
	.service('masterDataSvc', ['Entity', 'Item',  '$q', function(Entity, Item, $q) {
	
		function createMasterDataTemplateObject(){
			var obj = angular.copy(Entity.newObjectTemplate);
			obj.properties = [];
			for(var i = 0; i < 3; i++){
				var item = angular.copy(Item.newObjectTemplate);
				item.boi_name += ' ' +i;
				item.boi_column += i;
				obj.properties.push(item);
			}
			return obj;
		}
		
		this.masterDataTemplateObject = createMasterDataTemplateObject();
		this.batchLoadedMasterData = [];//data cache
		this.querySettings;
		this.selection = [];
		
		var self = this;
		
		this.getLoadedData = function(){
			return this.batchLoadedMasterData;
		};
			
		/* make sure that sort and order properties of settings have not changed when paging and after the first page has been loaded. purge and start over again otehrwise */
		function query(settings){
			this.querySettings = settings;
			settings.expanded = (settings && settings.expanded!==undefined) || true;
			var deferred = $q.defer();
			Entity.query(settings).$promise
			.then(jQuery.proxy(function(data){
				if(self.querySettings.limit){
					if(!self.querySettings.offset)
						self.batchLoadedMasterData = data;//invalidate cached data
					else
						self.batchLoadedMasterData = [].concat(self.batchLoadedMasterData, data);//append next page of data
				} else {
					self.batchLoadedMasterData = data;//overwrite
				}
				deferred.resolve(data);
			}, this), function(error){
				deferred.resolve(error);
			});
			return deferred.promise;
		};
		
		function refresh(){
			this.batchLoadedMasterData = [];
			this.querySettings.offset = 0;
			return query.apply(this, [this.querySettings]).then(self.count);
		};
		
		/* 
			Looks up an object with the given id in the currently loaded data, and if instructed by the reloadDataOnDemand parameter, 
			will lookup remotely the data service and reload the list to feature this item too.
			Note: With progessive loading and pagination patterns it is possible that an item exists but has not been loaded from remote service yet.
				  The second parameter addresses precisely these situations.	
		*/
		this.get = function(id, lookupRemotelyOnDemand){
			var itemHit = this.batchLoadedMasterData.filter(function(item){
					if(item.boh_id == id ){
						return true;
					}
					return false;
				})[0];
			if(itemHit) {
				return $q.when(itemHit);
			} else if(lookupRemotelyOnDemand) {
				return Entity.get({boId:id}).$promise
				.then(function(item){
					if(item){
						return self.next.apply(self);
					}
					return;
				})
				.then(function(){
					return self.get.apply(self, [id, lookupRemotelyOnDemand]);
				})
				.catch(function(response){
					if(response.status===404){
						return;
					} else {
						throw repsonse.data.err;
					}
				});
			}
			return;
		};

		this._itemsCount;

		this.count = function(){
			return Entity.count().$promise
			.then(function(_data){
				self._itemsCount = _data.count;
				return self._itemsCount;
			});
		};
		
		this.hasMore = function() {
			return self.count()
			.then(function(){
				return self._itemsCount > 0 && self._itemsCount > self.batchLoadedMasterData.length;
			});
		};
		
		this.select = function(selection){
			self.selection = selection;
		};
		
		this.next = function(){
			return this.hasMore()
			.then(function(_hasMore){
				if(_hasMore){
					self.querySettings.offset = self.batchLoadedMasterData.length;
					return query.apply(self, [self.querySettings])
					.then(function(){
						return self.batchLoadedMasterData;
					});
				}
				return;
			});
		};
		
		this.prev = function(){
			//TODO: not implemented;
			throw Error('Not implemented');
		};

		this.create = function(cascaded, template){
			var reqParams = {};
			reqParams.cascaded = cascaded || true;
			return Entity.save(reqParams, template || this.masterDataTemplateObject).$promise
			.then(function(newItem){
				return refresh.apply(self)
				.then(function(){
					return newItem;
				});
			});
		};
		
		this.update = function(header){
			if(header.properties){
				var items = header.properties.filter(function(item){
					if(!item.action){
						return false;
					}
					return true;
				});
				var promises = items.map(function(item) {
					var action = item.action;
					delete item.action;
					if(action === 'remove') {
			        	return Item.remove({boId: item.boi_id}).$promise;
		        	} else {
		        		return Item[action]({boId: item.boi_id}, item).$promise;
	        		}
		    	});
			}

			promises.unshift(Entity.update({boId: header.boh_id}, header).$promise);
			promises.push(refresh.apply(self));
	    	return $q.all(promises);
		};	
		
		this.remove = function(headerId, cascaded){
			var reqParams = {};
			if(cascaded)
				reqParams.cascaded = cascaded;
			reqParams.boId = headerId;
			var deferred = $q.defer();
			Entity.remove(reqParams).$promise
			.then(function(){
					refresh.apply(self)
					.then(function(){
						deferred.resolve();
					}, function(refreshErr){
						deferred.reject(refreshErr);
					});
				},
				function(removeErr){
					deferred.reject(removeErr);
				});
			return deferred.promise;
		};
		
		this.serviceErrorMessageFormatter = function(message, errorPayload){
			if(errorPayload.data.err.code){
				message += ': [' + errorPayload.data.err.code + '] ';
			}
			if(errorPayload.data.err.message){
				message += ' ' + errorPayload.data.err.message;
			}
			return message;
		};
				
	}])
	.controller('EmptyCtrl', ['masterDataSvc', '$log', '$state', '$stateParams', function (masterDataSvc, $log, $state, $stateParams) {
	
		this.createItem = function(){
			masterDataSvc.create()
			.then(function(newItem){
				$stateParams.boId = newItem.boh_id;
				$stateParams.message = {
					text: 'New Buisness Object successfully created.',
					type: 'alert-success'
				};
			}, function(reason){
				var message = masterDataSvc.serviceErrorMessageFormatter('Creating new Buisness Object failed', reason);
				$log.error(message);			
				$stateParams.message = {
						text: message,
						type: 'alert-danger'
				};
			})
			.finally(function(){
				$state.go($state.current, $stateParams, {reload: true});
			});
		};
	
	}])
	.controller('MasterListCtrl', ['masterDataSvc', 'BuildService', 'modalService', '$log', '$q', '$state', '$stateParams', '$window', function (masterDataSvc, BuildService, modalService, $log, $q, $state, $stateParams, $window) {

		this.items = masterDataSvc.getLoadedData();
		this.selectedEntity = masterDataSvc.selection[0];
		this.count = masterDataSvc._itemsCount;
		this.showLoadMore;
		this.busy;
		
		this.querySettings = {
			limit: 100,
			sort: 'boh_name',
			order: 'ASC'
		};
		
		var loadMoreBreakNumber = this.querySettings.limit*2;
		var self = this;
		
		function initList(selectedEntity) {
			this.items = masterDataSvc.getLoadedData();
			if(this.items.length > 0) {
				var selectedEntityId;
				if(!selectedEntity){
					selectedEntityId = $stateParams.boId || $state.params.boId || this.items[0].boh_id;
				} else {
					selectedEntityId = selectedEntity.boh_id;
				}
				masterDataSvc.get(selectedEntityId, true)
				.then(function(item){
					//the list might have been expanded to search for an entity by deep link so it needs to be initialized again.
					self.items = masterDataSvc.getLoadedData();
					if(item === undefined){
						fireLocationError.apply(self);
						item = self.items[0];
					}
					return self.selectItem.apply(self, [item]);//select the selection candidate
				})
				.then(function(){
					if(self.items.length === loadMoreBreakNumber){
						return masterDataSvc.hasMore()
						.then(function(_hasMore){
							self.showLoadMore = _hasMore;
							loadMoreBreakNumber = loadMoreBreakNumber + self.querySettings*2;
						});
					} else {
						self.showLoadMore = false;
					}
					self.count = masterDataSvc._itemsCount;
					return;
				})
				.catch(function(error){
					handleServiceError('Looking up Buisness Object failed', error.message);
					$state.go($state.current, $stateParams, {reload: true});
				})
				.finally(function(){
					if(!self.showLoadMore)
						self.busy = false;
				});
			}
		};
		
		function fireLocationError(){
			$log.debug('The requested application path ' + $window.location.href + " is not valid.");
			$stateParams.message = {
				text: $window.location.href + ' is not valid application path. Check the URL and try again.',
				type: 'alert-danger'
			};
		}

		this.selectItem = function(item){
			masterDataSvc.select([item]);
			self.selectedEntity = item;
			$stateParams = angular.extend($stateParams, {
				selectedEntity: item,
				boId: item.boh_id
			});
			$state.go('list.entity', $stateParams, {reload: false});
		};
		
		this.createItem = function(){
			masterDataSvc.create()
			.then(function(newItem){
				$stateParams.boId = newItem.boh_id;
				$stateParams.selectedEntity = newItem;
				$stateParams.message = {
					text: 'New Buisness Object successfully created.',
					type: 'alert-success'
				};
				masterDataSvc.selection = [newItem];
				initList.apply(self, [masterDataSvc.selection[0]]);
				return;
			})
			.catch(function(reason){
				handleServiceError('Creating new Buisness Object failed', reason);
			})
			.finally(function(){
				$state.go("list.entity", $stateParams, {reload: false});
			});
		};
		
		this.deleteItem = function(entity){
			
			var modalOptions = {
	            closeButtonText: 'Cancel',
	            actionButtonText: 'Delete entity',
	            headerText: 'Delete "' + entity.boh_name + '"?',
	            bodyText: 'Are you sure you want to delete this entity?'
	        };
	
	        modalService.showModal({}, modalOptions)
	        .then(function (result) {
				self.busy = true;
				masterDataSvc.remove(entity.boh_id)
				.then(function(){
					delete $stateParams.boId;
					delete $state.params.boId;
					delete $stateParams.selectedEntity;
					delete $state.params.selectedEntity;					
					$stateParams.message = {
							text: 'Buisness Object successfully deleted.',
							type: 'alert-success'
						};

				})
				.catch(function(reason){
					handleServiceError('Deleting Buisness Object failed', reason);
				})
				.finally(function(){
					$state.go($state.current, $stateParams, {reload: true, inheirt: false});
					initList.apply(self);
				});	        
	        });
	        
		};
		
		function handleServiceError(text, errorPayload){
			var message = masterDataSvc.serviceErrorMessageFormatter(text, errorPayload);
			$log.error(message);			
			$stateParams.message = {
					text: message,
					type: 'alert-danger'
			};
		};
		
		this.next = function(){
			if(!self.busy || (self.busy && self.showLoadMore)){
				masterDataSvc.querySettings = this.querySettings;
				$q.when(masterDataSvc.next())
				.catch(function(err){
					console.error(err);
					//..
				})
				.finally(function(){
					initList.apply(self, [masterDataSvc.selection[0]]);
				});			
			}
			self.busy = true;
		};
		
		this.build = function(){
			BuildService.build(self.items);
		};

	}])
	.controller('DetailsCtrl', ['masterDataSvc', 'modalService', 'selectedEntity', '$log', '$state', '$stateParams' , function (masterDataSvc, modalService, selectedEntity, $log, $state, $stateParams) {
		
		this.selectedEntity = selectedEntity;
		var self = this;
		
	//FIXME!!!	
		this.showProperties = function(){
			if(this._selectedItemDetails){
				this.selectedItemDetails = this._selectedItemDetails.filter(function(v, i, arr){
					if(!v.boi_type || v.boi_type!=='Relationship'){
						return true;
					}
					return false;
				}, this);
			}
		};
		
		function showDetails(item){
			if(item){
				this._selectedItemDetails = item.properties;
				this.showProperties.apply(this);//Initial content to show	
			}
		}
		
		showDetails.apply(this, [this.selectedEntity]);
		
		this.showRelationships = function(){
			if(this._selectedItemDetails){
				this.selectedItemDetails = this._selectedItemDetails.filter(function(v, i, arr){
					if(v.boi_type && v.boi_type==='Relationship'){
						return true;
					}
					return false;
				}, this);
			}
		};
		
		function handleServiceError(text, errorPayload){
			var message = masterDataSvc.serviceErrorMessageFormatter(text, errorPayload);
			$log.error(message);			
			$stateParams.message = {
					text: message,
					type: 'alert-danger'
			};	
		};
		
		this.startEdit = function() {
		    $stateParams.entityForEdit = angular.copy(this.selectedEntity);		    
		    $state.go("list.entity.edit", $stateParams, {location:false});
		};
		
		this.duplicateItem = function() {
			var modalOptions = {
	            closeButtonText: 'Cancel',
	            actionButtonText: 'Duplicate entity',
	            headerText: 'Duplicate "' + self.selectedEntity.boh_name + '"?',
	            bodyText: 'Are you sure you want to duplicate this entity?'
	        };
	
	        modalService.showModal({}, modalOptions)
	        .then(function () {
				var duplicateItem = angular.copy(self.selectedEntity, {});
				delete duplicateItem.boh_id;
				masterDataSvc.create(undefined, duplicateItem)
					.then(function(newItem){
						$stateParams.boId = newItem.boh_id;
						$stateParams.message = {
							text: 'Buisness Object successfully duplicated.',
							type: 'alert-success'
						};					
						$state.go($state.current, $stateParams, {reload: true, location:true, inherit: true});
					}, function(reason){
						handleServiceError('Duplicating Buisness Object failed', reason);
						$state.go('^', $stateParams, {reload: true});
					});        	
        	});
		};
		
		this.deleteItem = function() {
			var modalOptions = {
	            closeButtonText: 'Cancel',
	            actionButtonText: 'Delete entity',
	            headerText: 'Delete "' + self.selectedEntity.boh_name + '"?',
	            bodyText: 'Are you sure you want to delete this entity?'
	        };
	
	        modalService.showModal({}, modalOptions)
	        .then(function () {
				masterDataSvc.remove(self.selectedEntity.boh_id)
				.then(function(){
					delete $stateParams.boId;			
					$stateParams.message = {
							text: 'Buisness Object successfully deleted.',
							type: 'alert-success'
						};
				})
				.catch(function(reason){
					handleServiceError('Deleting Buisness Object failed', reason);
				})
				.finally(function(){
					$state.go('^', $stateParams, {reload: true, inheirt: false});
				});
        	
        	});
		};
		
	}])
	.controller('EditCtrl', ['masterDataSvc', 'modalService', 'selectedEntity', '$log', '$state', '$stateParams', function (masterDataSvc, modalService, selectedEntity, $log, $state, $stateParams) {

		this.selectedEntity = selectedEntity;
		var self = this;
	//FIXME!!!	
		this.showProperties = function(){
			if(this._selectedItemDetails){
				this.selectedItemDetails = this._selectedItemDetails.filter(function(v, i, arr){
					if(!v.boi_type || v.boi_type!=='Relationship'){
						return true;
					}
					return false;
				}, this);
			}
		};
		
		function showDetails(item){
			if(item){
				this._selectedItemDetails = item.properties;
				this.showProperties.apply(this);//Initial content to show	
			}
		}
		
		showDetails.apply(this, this.selectedEntity);
		
		this.showRelationships = function(){
			if(this._selectedItemDetails){
				this.selectedItemDetails = this._selectedItemDetails.filter(function(v, i, arr){
					if(v.boi_type && v.boi_type==='Relationship'){
						return true;
					}
					return false;
				}, this);
			}
		};
		
		this.openPropertyEditor = function(item){
			$state.go('list.entity.edit.items', {
				selectedEntity: this.selectedEntity,
				item: item
			}, {location: false});
		};
		
		this.deleteProperty = function(item){
			var modalOptions = {
	            closeButtonText: 'Cancel',
	            actionButtonText: 'Delete',
	            headerText: 'Delete property "' + item.boi_name + '"?',
	            bodyText: 'Are you sure you want to delete this property?'
	        };
	        
	        modalService.showModal({}, modalOptions)
	        .then(function () {
				for(var i=0; i< self.selectedEntity.properties.length; i++){
					if(self.selectedEntity.properties[i] === item){
						self.selectedEntity.properties.splice(i,1);
						break;
					}
				}
				$stateParams.entityForEdit.properties = $stateParams.entityForEdit.properties.map(
					function(currItem){
						if(currItem.boi_id && currItem.boi_id === item.boi_id){
							currItem.action = 'remove';
						}
						return currItem;
					});				
	        });
	        
		};
		
		this.cancelEdit = function() { 
			var modalOptions = {
	            closeButtonText: 'Cancel',
	            actionButtonText: 'OK',
	            headerText: 'Changes will be lost. Cancel editing "' + self.selectedEntity.boh_name + '"?',
	            bodyText: 'Are you sure you want to cancel your changes?'
	        };
	
	        modalService.showModal({}, modalOptions)
	        .then(function () {
				delete $stateParams.boIdedit;
				delete $stateParams.entityForEdit;
			    $state.go('^', $stateParams);
	        });
		};
		
		this.saveItem = function() {

		    masterDataSvc.update(this.selectedEntity)
		    .then(function(){
				$state.go('^', {boId: self.selectedEntity.boh_id, selectedEntity:self.selectedEntity}, {reload: 'list', location:false});
	    	})
	    	.catch(function(reason){
	    		var message = masterDataSvc.serviceErrorMessageFormatter('Updating Buisness Object failed', reason);
				$log.error(message);
				$stateParams.message = {
						text: message,
						type: 'alert-danger'
				};				
				$state.go($state.current, $stateParams, {reload: false});
			});	  
		};
				
	}])
	.controller('PropertyEditorCtrl', ['$scope', 'Item', '$stateParams', 'selectedEntity', function($scope, Item, $stateParams, selectedEntity) {
    	
		var isNewProperty;
		
		this.typeOptions = [{
								id: '1',
								val: 'Integer'
							},{
								id: '2',
								val: 'String'
							},{
								id: '3',
								val: 'Boolean'
							}];
		
		this.selectedTpeOption = {
				id: '2',
				val: 'String'
			};
		
		this.typeSelectionChanged = function(){
			this.item.type = this.selectedTypeOption.val;
		}
		
		$scope.$on('$viewContentLoaded', function(event) {
		      $timeout(function() {
		    	//$("form [type='checkbox']").bootstrapSwitch();
		      },0);
		    });
		
		function init(){
			isNewProperty = $stateParams.item === undefined ? true : false;
			if(isNewProperty) {
				this.item = angular.copy(Item.newObjectTemplate);
				this.item.boi_boh_id = $stateParams.selectedEntity.boh_id;
			} else {
				this.item = $stateParams.item;
			}
		}
        
       this.cancel = function() {
          $scope.$dismiss($stateParams.selectedEntity);
        };

        this.ok = function() {
          
	      if(isNewProperty){
	      	this.item.action = 'save';
	      	selectedEntity.properties.push(this.item);
	      	$stateParams.entityForEdit = $stateParams.selectedEntity = selectedEntity;
	      } else {
	      	this.item.action = 'update';
	    	selectedEntity = $stateParams.entityForEdit = $stateParams.selectedEntity; 
	      }
          $scope.$close(selectedEntity);
        };
        
        init.apply(this);
        
      }])
	.controller('NotificationsCtrl', ['$timeout', '$stateParams', function ($timeout, $stateParams) {
		
		var messageEl = $('.alert');
		this.message = $stateParams.message;
		
		this.hide = hideMessage;
		
		var timer;
		
		if(this.message){
			
			this.messageTypeClass = this.message.type || 'alert-danger';
			var self = this;			
			timer = $timeout(5000)
				.then(function(){
					hideMessage.apply(self);
				});	
		}
		
		function hideMessage(element){
			if(this.message){
				element = element || messageEl;
				$(element).fadeTo('slow', 0, function(){
					$(element).parent().slideUp('slow', function(){
						this.message = undefined;
						$timeout.cancel(timer);
					});
				});	
			}
		}

		this.destroy = function(){
			if(timer){
				$timeout.cancel(timer);
			}
		}
				
	}])
	.run(['editableOptions', function(editableOptions)  {
	  editableOptions.theme = 'bs3'; // bootstrap3 theme. Can be also 'bs2', 'default'
	}]);
	
	</script>

</body>
</html>
