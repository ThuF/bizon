<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Business Object</title>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.css">
<link rel="stylesheet" href="css/xeditable.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-switch/3.3.2/css/bootstrap3/bootstrap-switch.min.css">
<link rel="stylesheet" href="css/default.css">
</head>

<body ng-app="businessObjects">

	<div class="container-fluid">
		
		<div class="row-fluid page">
		
			<header class="page-title"><h1 class="h2">Business Objects Explorer</h1></header>
			
			<div class="page-content">
				<div ui-view="master" ng-show="items" class="master col-xs-12 col-md-2 no-gutter-left"></div>
				<div ui-view="detail"></div>
			</div>
			<div ui-view="notifications" class="notification-bar"></div>
			
		</div>
		
	</div>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>	
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.js"></script>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.3.1/angular-ui-router.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/1.3.3/ui-bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/1.3.3/ui-bootstrap-tpls.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular-resource.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular-animate.min.js"></script>
			
	<script src="js/xeditable.js"></script>	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-switch/3.3.2/js/bootstrap-switch.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.15.0/jquery.validate.min.js"></script>
	
	<script>
	angular.module('businessObjects', ['ngAnimate', 'ngResource', 'ui.router', 'ui.bootstrap', 'xeditable'])
	.config(['$stateProvider', '$urlRouterProvider', function($stateProvider, $urlRouterProvider) {
		
		$urlRouterProvider.otherwise("/");
		
		$stateProvider
		.state('items', {
			  url: "/",
		      params: {
		    	  message: undefined  
		      },
		      views: {
		          'master': {
		              templateUrl: 'partials/master-list.html',
		              controller: 'MasterListCtrl'
		          },
		          'detail': {
		              templateUrl: 'partials/empty.html',
		          },
		          'notifications': {
		              templateUrl: 'partials/notifications.html',
		              controller: 'NotificationsCtrl'
		          }
		      }
		    })
		.state('items.select', {
			  url: ":boId",
		      params: {
		    	  items: undefined,
				  selectedItem: undefined
		      },
		      views: {
		    	  'detail@': {
					  templateUrl: "partials/detail_view.html",
					  controller: 'DetailsCtrl'
			      }
		      }
		    })
		.state('items.select.edit', {
			  url: "edit",
		      params: {
		    	  items: undefined,
		    	  selectedItem: undefined,
		    	  itemForEdit: undefined,
		    	  message: {value: undefined}  
		      },
		      views: {
		          'master@': {
		              templateUrl: 'partials/master-list.html',
		              controller: 'MasterListCtrl'
		          },
			      'detail@': {
					  templateUrl: "partials/detail_editor.html",
					  controller: 'EditCtrl'
			      }
		      }
		    })
		.state("items.select.edit.property", {
			url: "propertyAdd",
		    params: {
				selectedItem: undefined,
				property: undefined,
				message: {value: undefined}
		    },
		    onEnter: ['$stateParams', '$state', '$uibModal', function($stateParams, $state, $modal) {
		    	
		    	function goBack(_selectedItem) {
		        	$state.go("items.select.edit", {selectedItem: _selectedItem}, {location:false});
		        }
		    	
		        var modalInstance = $modal.open({
		        	animation: true,
		            templateUrl: "partials/propertyEditor.html",
		            resolve: {
		            	selectedItem: function() { 
		            		return $stateParams.selectedItem; 
		            	}
		            },
		            controller: 'PropertyEditorCtrl'
		        });
		        modalInstance.rendered.then(function(){
		        	var $validator = $('.modal-body form').validate({
		        		errorClass: 'has-error',
		        		validClass : 'has-success',
 		        		highlight: function (element, errorClass, validClass) {
				            $(element).closest('.form-group').removeClass('has-success').addClass('has-error');
				            if($validator.numberOfInvalids()>0)
				            	$('.modal-footer .btn.btn-success').addClass('disabled');
				        },
				        unhighlight: function(element, errorClass, validClass) {
				        	$(element).closest('.form-group').removeClass('has-error').addClass('has-success');
				        	if($validator.numberOfInvalids()<1)
					        	$('.modal-footer .btn.btn-success').removeClass('disabled');	
				        },
		 		        success: "has-success"
		        	});
		        	$('.form-control[required]').each(function(i){
		        		$validator.element(this);
		        	});
		        });
		        modalInstance.result.then(goBack, goBack);
		    }]
		  });		    
	}])
	.service('Entity', function($resource) {
	  return $resource('../../js/bo_modeller/bo_header.js/:boId', { boId:'@id' }, {
		    create: {
		        method: 'POST'
		      },
		    update: {
		        method: 'PUT'
		      }
		    });
	})
	.controller('MasterListCtrl', ['Entity', '$scope', 'orderByFilter', '$rootScope', '$state', '$stateParams', '$window', function (Entity, $scope, orderBy, $rootScope, $state, $stateParams, $window) {
		
		/*Controller invoked upon routing or navigation click events*/
		
		$scope.items = $stateParams.items;
		$scope.selectedItem= $stateParams.selectedItem;
		
		$scope.isDisabled = $stateParams.itemForEdit!==undefined;
		
		$scope.sortByPropertyName = 'boh_name';
	    $scope.reverse = false;//ASC
		
	 	$scope.sortBy = function(propertyName) {
		    $scope.reverse = (propertyName !== null && $scope.propertyName === propertyName)
		        ? !$scope.reverse : false;
		    $scope.sortByPropertyName = propertyName;
		    $scope.items = orderBy($scope.items, $scope.sortByPropertyName, $scope.reverse);
		};
		
		$scope.selectItem = function(item){
			if(!$scope.selectedItem && !item || ($scope.selectedItem && $scope.selectedItem.boh_id === item.boh_id))//noops
				return;
			if(item){
				$scope.selectedItem = item;// save the selected item
				$state.go('items.select', {
					selectedItem: item,
					boId: item.boh_id
				})
			}
		}

		function init(){
			var itemId = $state.params.boId;
			if(!$scope.items){
				Entity.query().$promise
				.then(function(result){
					if(result && result.length>0){
						
						$scope.items = result;//initialize the items to display
						$scope.sortBy($scope.sortByPropertyName);
						
						itemId = itemId || result[0].boh_id;					
						var item = findItemById(result, itemId);
						if(item === undefined){
							fireLocationError.apply(this);
							item = result[0];	
						}
						$scope.selectItem.apply($scope, [item]);//set the requested item selected
						
					} else {
						if(itemId !== undefined){
							fireLocationError.apply($scope);
							$state.go('items', $stateParams);
						}
					}
				});	
			}
		}
		
		function findItemById(items, itemId){
			var item;
			for(var i=0; i< items.length; i++){
				if(items[i].boh_id == itemId ){
					item = items[i];
					break;
				}
			}
			return item;
		}
		
		function fireLocationError(){
			$stateParams.message = {
					text:$window.location.href + " is not valid application path. Check the URL and try again.",
					type: 'alert-danger'
			}
		}
		
		init.apply(this);
		
		$scope.createItem = function(){
			Entity.save({
						"boh_name":"Business Object Name",
						"boh_table": "BO_TABLE_NAME",
						"boh_description":"Description for business object",
						"boh_key":"Id",
		
						"properties": [{
							"boi_name":"Id",
							"boi_type":"Integer",
							"boi_nullable":0,
							"boi_key": true
						}]
					}).$promise
			.then(function(newItem){
				$stateParams.boId = newItem.boh_id;
				$stateParams.message = {
					text: 'New Buisness Object successfully created.',
					type: 'alert-success'
				}
				$state.go($state.current, $stateParams, {reload: true});
			})
		}
		
		$scope.deleteItem = function(itemId){
			Entity.remove({boId: itemId}).$promise
			.then(function(){
				//$state.reload();
				delete $stateParams.boId;
				$stateParams.message = {
						text: 'Buisness Object successfully deleted.',
						type: 'alert-success'
					}
				$state.go($state.current, $stateParams, {reload: true, location:false, inherit: false});
			})
		}
		
	}])
	.controller('DetailsCtrl', ['Entity', '$scope', '$state', '$stateParams' , function (Entity, $scope, $state, $stateParams) {
		
		$scope.selectedItem = $stateParams.selectedItem;
		$scope.selectedItemDetails;
				
		$scope.showProperties = function(){
			if($scope._selectedItemDetails){
				$scope.selectedItemDetails = $scope._selectedItemDetails.filter(function(v, i, arr){
					if(!v.boi_type || v.boi_type!=='Relationship'){
						return true;
					}
					return false;
				}, this);
			}
		};
		
		function showDetails(item){
			if(item){
				$scope._selectedItemDetails = item.properties;
				$scope.showProperties.apply(this);//Initial content to show	
			}
		}
		
		showDetails($scope.selectedItem);
		
		$scope.showRelationships = function(){
			if($scope._selectedItemDetails){
				$scope.selectedItemDetails = $scope._selectedItemDetails.filter(function(v, i, arr){
					if(v.boi_type && v.boi_type==='Relationship'){
						return true;
					}
					return false;
				}, this);
			}
		};
		
		$scope.startEdit = function() {
		    $stateParams.itemForEdit = angular.copy($scope.selectedItem);		    
		    $state.go("items.select.edit", $stateParams, {location:false});
		}
		
		$scope.duplicateItem = function() {
			var duplicateItem = angular.copy($scope.selectedItem, {});
			delete duplicateItem.boh_id;
			Entity.save(duplicateItem).$promise
				.then(function(newItem){
					$stateParams.boId = newItem.boh_id;
					$state.go($state.current, $stateParams, {reload: true, location:true, inherit: true});
				});
		}
		
		$scope.deleteItem = function() {
			Entity.remove({boId: $scope.selectedItem.boh_id}).$promise
			.then(function(){
				//$state.reload();
				delete $stateParams.boId;
				$stateParams.message = {
						text: 'Buisness Object successfully deleted.',
						type: 'alert-success'
					}
				$state.go($state.current, $stateParams, {reload: true, location:false, inherit: false});
			})
		}
		
	}])
	.controller('EditCtrl', ['Entity', '$scope', '$rootScope','$state', '$stateParams', function (Entity, $scope, $rootScope, $state, $stateParams) {
		
		$scope.selectedItem = $stateParams.itemForEdit;
		$scope.selectedItemDetails;
		
		function showDetails (item){
			$scope._selectedItemDetails = item.properties;
			$scope.showProperties.apply(this);//Initial content to show
		}
		
		$scope.showProperties = function(){
			if($scope._selectedItemDetails){
				$scope.selectedItemDetails = $scope._selectedItemDetails.filter(function(v, i, arr){
					if(!v.boi_type || v.boi_type!=='Relationship'){
						return true;
					}
					return false;
				}, this);
			}
		};
		
		showDetails.apply(this, [$scope.selectedItem]);
		
		$scope.showRelationships = function(){
			if($scope._selectedItemDetails){
				$scope.selectedItemDetails = $scope._selectedItemDetails.filter(function(v, i, arr){
					if(v.boi_type && v.boi_type==='Relationship'){
						return true;
					}
					return false;
				}, this);
			}
		};
		
		$scope.openPropertyEditor = function(property){
			$state.go('items.select.edit.property', {
				selectedItem: $scope.selectedItem,
				property: property
			}, {location: false});
		}
		
		$scope.deleteProperty = function(property){
			for(var i=0; i< $scope.selectedItem.properties.length; i++){
				if($scope.selectedItem.properties[i] === property){
					$scope.selectedItem.properties.splice(i,1);
					showDetails.apply(this, [$scope.selectedItem]);
					break;
				}
			}
		}
		
		$scope.cancelEdit = function() {
			delete $stateParams.boIdedit;
			delete $stateParams.itemForEdit;
		    $state.go("^", $stateParams);
		}
		
		$scope.saveItem = function() {
		    Entity.update($scope.selectedItem).$promise
		    	.then(function(item){
					$state.go('items.select', {boId: $scope.selectedItem.boi_id})	
		    	})
		}
				
	}])
	.controller('PropertyEditorCtrl', ['$scope', '$stateParams', 'selectedItem', '$timeout', function($scope, $stateParams, selectedItem, $timeout) {
    	
		var isNewProperty;
		
		$scope.typeOptions = [{
								id: '1',
								val: 'Integer'
							},{
								id: '2',
								val: 'String'
							},{
								id: '3',
								val: 'Boolean'
							}];
		
		$scope.selectedTypeOption = {
				id: '3',
				val: 'String'
			};
		
		$scope.typeSelectionChanged = function(){
			$scope.property.type = $scope.selectedTypeOption.val;
		}
		
		$scope.$on('$viewContentLoaded', function(event) {
		      $timeout(function() {
		    	//$("form [type='checkbox']").bootstrapSwitch();
		      },0);
		    });
		
		function init(){
			isNewProperty = $stateParams.property === undefined ? true : false;
			if(isNewProperty){
				$scope.property = {
					type: "String"
				}
			} else {
				$scope.property = $stateParams.property;
			}
			for(var i=0; i<$scope.typeOptions.length; i++){
				if($scope.typeOptions[i].val === $scope.property.boi_type){
					$scope.selectedTypeOption = $scope.typeOptions[i];
					break;
				}
			}
		}
        
        $scope.cancel = function() {
          $scope.$dismiss($stateParams.selectedItem);
        };

        $scope.ok = function() {
          
	      if(isNewProperty){
	      	selectedItem.properties.push($scope.property);      		
	      	$stateParams.itemForEdit = $stateParams.selectedItem = selectedItem;
	      } else {
	    	selectedItem = $stateParams.itemForEdit = $stateParams.selectedItem; 
	      }
          $scope.$close(selectedItem);
        };
        
        init.apply(this);
        
      }])
	.controller('NotificationsCtrl', ['$scope', '$timeout', '$animate', '$stateParams', function ($scope, $timeout, $animate, $stateParams) {
		
		var messageEl = $('.alert');
		$scope.message = $stateParams.message;
		
		$scope.hide = hideMessage;
		
		var timer;
		
		if($scope.message){
			
			$scope.messageTypeClass = $scope.message.type || 'alert-danger';
			
			timer = $timeout(5000)
				.then(function(){
					hideMessage.apply(this);
				});	
		}
		
		function hideMessage(element){
			if($scope.message){
				element = element || messageEl;
				$(element).fadeTo('slow', 0, function(){
					$(element).parent().slideUp('slow', function(){
						$scope.message = undefined;
						$timeout.cancel(timer);
						$scope.$apply();
					});
				});	
			}
		}
		

		$scope.destroy = function(){
			if(timer){
				$timeout.cancel(timer);
			}
		}
				
	}])
	.run(['editableOptions', function(editableOptions)  {
	  editableOptions.theme = 'bs3'; // bootstrap3 theme. Can be also 'bs2', 'default'
	}]);
	
	</script>

</body>
</html>
