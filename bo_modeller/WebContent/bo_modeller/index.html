<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Business Object</title>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.css">
<link href="css/xeditable.css" rel="stylesheet">
<link href="css/default.css" rel="stylesheet">
</head>

<body ng-app="businessObjects">

	<div class="container-fluid page">
		
		<header class="page-title"><h1 class="h2">Business Objects Explorer</h1></header>
		
		<div class="row-fluid split-app">
		
			<div>
				<div class="alert alert-danger" ng-show="errorMessage" ng-controller="ErrorCtrl">{{errorMessage}} <span ng-click="hide()" class="glyphicon glyphicon-remove pull-right tools-remove" aria-hidden="true"></span></div>
			</div>
			
			<div ui-view="master" ng-show="items" class="master col-xs-12 col-md-2 no-gutter-left"></div>
			
			<div ui-view="detail" style="display: inline"></div>

		</div>
	</div>
	
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.js"></script>
	<!-- <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular-route.min.js"></script> -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.3.1/angular-ui-router.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular-resource.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular-animate.min.js"></script>

	<script src="js/xeditable.js"></script>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	
	<script>
	angular.module('businessObjects', ['ngAnimate', 'ui.router', 'ngResource', 'xeditable'])
	.config(['$stateProvider', '$urlRouterProvider', function($stateProvider, $urlRouterProvider) {
		
		$urlRouterProvider.otherwise("/");
		
		$stateProvider
	    .state('items', {
	      url: "/",
	      views: {
	          'master': {
	              templateUrl: 'partials/master-list.html',
	              controller: 'MasterCtrl'
	          },
	          'detail': {
	              templateUrl: 'partials/empty.html'
	          }
	      }
	    })
	    .state('items.detail', {
	    	url: ":boId",
	    	views: {
		    	'detail@': {
					templateUrl: "partials/detail_view.html",
					controller: 'DetailsCtrl'
		        }
	    	}
	    })
	    .state('items.detail.edit', {
	    	url: ":boId",
	    	params: {
	    		itemForEdit: undefined
	    	},
	    	views: {
		    	'detail@': {
					templateUrl: "partials/detail_editor.html",
					controller: 'EditCtrl'
		        }
	    	}
	    })
	}])
	.service('Entity', function($resource) {
	  return $resource('api/bos/:boId', { boId:'@id' }, {
		    create: {
		        method: 'POST'
		      },
		    update: {
		        method: 'PUT'
		      }
		    });
	})
	.controller('MasterCtrl', ['Entity', '$scope', '$rootScope', '$state', '$stateParams', '$window', function (Entity, $scope, $rootScope, $state, $stateParams, $window) {
		
		/*Controller invoked upon routing or navigation click events*/
		
		$scope.items;
		$scope.selectedItem;

		$scope.selectItem = function(item){
			if(!$scope.selectedItem && !item || ($scope.selectedItem && $scope.selectedItem.id === item.id))//noops
				return;
			if(item){
				$scope.selectedItem = item;// save the selected item 
			}
			$state.go('items.detail', {'boId': item.id})
				.then(function(){
					//broadcast selection change event to interested listeners
					$rootScope.$broadcast('ItemSelectionChange', {
							"selection": item
						});
				});
		}

		function init(){
			var itemId = $state.params.boId;  
			if(itemId && $scope.selectedItem && $scope.selectedItem.id===itemId){ //trying to select an item that is already selected
				return;
			}
			Entity.query().$promise
			.then(function(result){
				var item;
				if(result && result.length>0){
					
					itemId = itemId || result[0].id;
					
					item = findItemById(result, itemId);
					
					if(item === undefined){
						fireLocationError.apply(this);
						item = result[0];	
					}
					
					$scope.items = result;//initialize the items to display
					$scope.selectItem.apply($scope, [item]);//set the requested item selected
					
				} else {
					if(itemId !== undefined){
						fireLocationError.apply($scope);
						$state.go('items', undefined, {location:false});
					}
				}
			});
		}
		
		function findItemById(items, itemId){
			var item;
			for(var i=0; i< items.length; i++){
				if(items[i].id === itemId ){
					item = items[i];
					break;
				}
			}
			return item;
		}
		
		function fireLocationError(){
			$rootScope.$broadcast('ApplicationError', {
				"errorMessage": $window.location.href + " is not valid application path. Check the URL and try again."
			});	
		}
		
		init.apply(this);
		
		$scope.createItem = function(){
			Entity.save({
						"name":"Business Object Name",
						"description":"Description for business object",
						"key":"Id",
						"table":"TBL_NAME",
		
						"properties": [{
							"name":"Id",
							"type":"Integer",
							"key": true
						}]
					}).$promise
			.then(function(newItem){
				$stateParams.boId = newItem.id;
				$state.go($state.current, $stateParams, {reload: true, location:true, inherit: true});
			})
		}
		
		$scope.deleteItem = function(itemId){
			Entity.remove({boId: itemId}).$promise
			.then(function(){
				//$state.reload();
				$state.go($state.current, $stateParams, {reload: true, location:false, inherit: false});
			})
		}
		
	}])
	.controller('DetailsCtrl', ['Entity', '$scope', '$state', '$stateParams' , function (Entity, $scope, $state, $stateParams) {
		
		$scope.selectedItem;
		$scope.selectedItemDetails;
		
		$scope.$on('ItemSelectionChange', function(evt, data){
			$scope.selectedItem = data.selection;
			if($scope.selectedItem)
				showDetails($scope.selectedItem);
			else
				$scope.message = "Not Found"
		});
		
		function showDetails (item){
			$scope._selectedItemDetails = item.properties;
			$scope.showProperties.apply(this);//Initial content to show
		}
		
		$scope.showRelationships = function(){
			if($scope._selectedItemDetails){
				$scope.selectedItemDetails = $scope._selectedItemDetails.filter(function(v, i, arr){
					if(v.type && v.type==='Relationship'){
						return true;
					}
					return false;
				}, this);
			}
		};
		
		$scope.showProperties = function(){
			if($scope._selectedItemDetails){
				$scope.selectedItemDetails = $scope._selectedItemDetails.filter(function(v, i, arr){
					if(!v.type || v.type!=='Relationship'){
						return true;
					}
					return false;
				}, this);
			}
		};
		
		$scope.startEdit = function() {
		    $stateParams.itemForEdit = angular.copy($scope.selectedItem);
		    $state.go("items.detail.edit", $stateParams, {location:false});
		}
		
		$scope.duplicateItem = function() {
			var duplicateItem = angular.copy($scope.selectedItem, {});
			delete duplicateItem.id;
			Entity.save(duplicateItem).$promise
				.then(function(newItem){
					$stateParams.boId = newItem.id;
					$state.go($state.current, $stateParams, {reload: true, location:true, inherit: true});
				});
		}
		
		$scope.deleteItem = function() {
			Entity.remove($scope.selectedItem).$promise
			.then(function(){
				$state.go($state.current, {boId: $scope.selectedItem.id}, {reload: true, location:true, inherit: true});
			})
		}
		
	}])
	.controller('EditCtrl', ['Entity', '$scope', '$state', '$stateParams', function (Entity, $scope, $state, $stateParams) {
		
		$scope.selectedItem = $stateParams.itemForEdit;
		$scope.selectedItemDetails;
		
		function showDetails (item){
			$scope._selectedItemDetails = item.properties;
			$scope.showProperties.apply(this);//Initial content to show
		}
		
		$scope.showProperties = function(){
			if($scope._selectedItemDetails){
				$scope.selectedItemDetails = $scope._selectedItemDetails.filter(function(v, i, arr){
					if(!v.type || v.type!=='Relationship'){
						return true;
					}
					return false;
				}, this);
			}
		};
		
		showDetails.apply(this, [$scope.selectedItem]);
		
		$scope.showRelationships = function(){
			if($scope._selectedItemDetails){
				$scope.selectedItemDetails = $scope._selectedItemDetails.filter(function(v, i, arr){
					if(v.type && v.type==='Relationship'){
						return true;
					}
					return false;
				}, this);
			}
		};
		
		$scope.cancelEdit = function(mode) {
		    $state.go($state.current, {boId: $scope.selectedItem.id}, {reload: true, location:true, inherit: true});
		}
		
		$scope.saveItem = function() {
		    Entity.update($scope.selectedItem).$promise
		    	.then(function(item){
		    		$state.go($state.current, {boId: $scope.selectedItem.id}, {reload: true, location:true, inherit: true});
		    	})
		}
		
	}])
	.controller('ErrorCtrl', ['$scope', '$timeout', '$animate', function ($scope, $timeout, $animate) {
		
		var errorMessageEl = $('.alert,.alert-danger'); 
		
		$scope.$on('ApplicationError', function(evt, data){
			$scope.errorMessage = data.errorMessage;
		});
		
		$scope.hide = hideErrorMessage;
		
		var timer;
		
		$animate.on('removeClass', errorMessageEl,
		  $.proxy(function (element, phase) {
			if('close' === phase && $scope.errorMessage){
				timer = $timeout(5000)
				.then(function(){
						hideErrorMessage.apply(this, [element]);
					});
			}
		  },this));
		
		function hideErrorMessage(element){
			if($scope.errorMessage){
				element = element || errorMessageEl;
				$(element).fadeTo('slow', 0, function(){
					$(element).parent().slideUp('slow', function(){
						$scope.errorMessage = undefined;
						$timeout.cancel(timer);
						$scope.$apply();
					});
				});	
			}
		}
				
	}])
	.run(['editableOptions', function(editableOptions)  {
	  editableOptions.theme = 'bs3'; // bootstrap3 theme. Can be also 'bs2', 'default'
	}]);
	
	</script>

</body>
</html>